---
title: "Lab Modeling: Bike rentals in DC"
author: Samal Abdikerimova, Carlos Salinas, and Xiran Yu
output:
  html_document
link-citations: yes
---

```{r photo, fig.margin = TRUE, echo = FALSE, fig.width=3, fig.cap="Photo by Viktor Kern on Unsplash"}
knitr::include_graphics("img/viktor-kern-UdGEXZtlx-E-unsplash.jpg")
```

Bike sharing systems are new generation of traditional bike rentals where whole process from membership, rental and return back has become automatic. Through these systems, user is able to easily rent a bike from a particular position and return back at another position. Currently, there are about over 500 bike-sharing programs around the world which is composed of over 500 thousands bicycles. Today, there exists great interest in these systems due to their important role in traffic, environmental and health issues.

Apart from interesting real world applications of bike sharing systems, the characteristics of data being generated by these systems make them attractive for the research. Opposed to other transport services such as bus or subway, the duration of travel, departure and arrival position is explicitly recorded in these systems. This feature turns bike sharing system into a virtual sensor network that can be used for sensing mobility in the city. Hence, it is expected that most of important events in the city could be detected via monitoring these data.

Source: [UCI Machine Learning Repository - Bike Sharing Dataset](http://archive.ics.uci.edu/ml/datasets/Bike+Sharing+Dataset)


# Packages

In this assignment we will work with the following packages. They should already
be installed in your project, and you can load them with the following:

```{r load-packages, eval=TRUE, message=FALSE}
library(tidyverse)
library(plyr)
library(broom)
```

# Data

The data include daily bike rental counts (by members and casual users) of Capital Bikeshare in Washington, DC in 2011 and 2012 as well as weather information on these days.

The original data sources are http://capitalbikeshare.com/system-data and http://www.freemeteo.com.

The codebook is below:

| Variable name    | Description
|:--------|:-------------------------------------------------------------
| `instant`		| record index
| `dteday`      | date
| `season`      | season (1:winter, 2:spring, 3:summer, 4:fall)
| `yr`          | year (0: 2011, 1:2012)
| `mnth`          | month (1 to 12)
| `holiday`     | whether day is holiday or not (extracted from http://dchr.dc.gov/page/holiday-schedule)
| `weekday`     | day of the week
| `workingday`| if day is neither weekend nor holiday is 1, otherwise is 0.
| `weathersit`| 1: Clear, Few clouds, Partly cloudy, Partly cloudy
|             | 2: Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist
|             | 3: Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds
|             | 4: Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog
| `temp`            | Normalized temperature in Celsius. The values are divided by 41 (max)
| `atemp`			| Normalized feeling temperature in Celsius. The values are divided by 50 (max)
| `hum`             | Normalized humidity. The values are divided by 100 (max)
| `windspeed`	| Normalized wind speed. The values are divided by 67 (max)
| `casual`		| Count of casual users
| `registered`| Count of registered users
| `cnt`           | Count of total rental bikes including both casual and registered

# Exercises

1. Load the dataset called `bikeshare-day.csv` that is located in the `data` folder with the `read_csv()` function. Save it as a data frame called `bike` in your environment.

```{r}
bike_share_data <- read_csv("data/bikeshare-day.csv")
```

## Data wrangling

2. Recode the `season` variable to be a factor with meaningful level names as
outlined in the codebook, with spring as the baseline level.

```{r}
bike_share_data$season <- factor(bike_share_data$season)
bike_share_data <- bike_share_data %>%
    mutate(season =
               mapvalues(bike_share_data$season,
                         levels(bike_share_data$season),
                         c("winter", "spring", "summer", "fall")))
bike_share_data$season <- relevel(bike_share_data$season,ref="spring")
```

3. Recode the binary variables `holiday` and `workingday` to be factors with
levels no (0) and yes (1), with no as the baseline level.

```{r}
bike_share_data$holiday <- factor(bike_share_data$holiday)
bike_share_data <- bike_share_data %>%
    mutate(holiday =
               mapvalues(bike_share_data$holiday,
                         levels(bike_share_data$holiday),
                         c("no", "yes")))
bike_share_data$holiday <- relevel(bike_share_data$holiday,ref="no")

bike_share_data$workingday <- factor(bike_share_data$workingday)
bike_share_data <- bike_share_data %>%
    mutate(workingday =
               mapvalues(bike_share_data$workingday,
                         levels(bike_share_data$workingday),
                         c("no", "yes")))
bike_share_data$workingday <- relevel(bike_share_data$workingday,ref="no")
```

4. Recode the `yr` variable to be a factor with levels 2011 and 2012, with 2011
as the baseline level.

```{r}
bike_share_data$yr <- factor(bike_share_data$yr)
bike_share_data <- bike_share_data %>%
    mutate(yr =
               mapvalues(bike_share_data$yr,
                         levels(bike_share_data$yr),
                         c("2011", "2012")))
bike_share_data$yr <- relevel(bike_share_data$yr,ref="2011")
```

5. Recode the `weathersit` variable as 1 - clear, 2 - mist, 3 - light precipitation,
and 4 - heavy precipitation, with clear as the baseline.

```{r}
bike_share_data$weathersit <- factor(bike_share_data$weathersit)
bike_share_data <- bike_share_data %>%
    mutate(weathersit =
               mapvalues(bike_share_data$weathersit,
                         levels(bike_share_data$weathersit),
                         c("clear", "mist", "light precipitation")))
bike_share_data$weathersit <- relevel(bike_share_data$weathersit,ref="clear")
```

6. Calculate raw temperature, feeling temperature, humidity, and windspeed as
their values given in the dataset multiplied by the maximum raw values stated
in the codebook for each variable. Instead of writing over the existing variables,
create new ones with concise but informative names.

```{r}
bike_share_data <- bike_share_data %>%
    mutate(raw_temp = temp * 41,
           raw_atemp = atemp * 50,
           raw_hum = hum * 100,
           raw_windspeed = windspeed * 67)
```

7. Check that the sum of `casual` and `registered` adds up to `cnt` for each record.
**Hint:** One way of doing this is to create a new column that takes on the value
`TRUE` if they add up and `FALSE` if not, and then checking if all values in
that column are `TRUE`s. But this is only one way, you might come up with another.

```{r}
bike_share_data <- bike_share_data %>%
    mutate(sum_cas_reg = casual + registered,
           cnt_p = (cnt == sum_cas_reg))
```

## Exploratory data analysis

7. Recreate the following visualization, and interpret it in context of the data.
*Hint: You will need to use one of the variables you created above. The temperature plotted is the feeling temperature.*

````{r plot-image, echo=FALSE, out.width='100%', eval = TRUE}
knitr::include_graphics('./data/plot.jpg')
```

```{r, eval = TRUE}
ggplot(data = bike_share_data) +
    geom_point(aes(x = dteday,
                   y = cnt,
                   color = raw_atemp))
```

8. Create a visualization displaying the relationship between bike rentals and
season. Interpret the plot in context of the data.

```{r}
ggplot(data = bike_share_data) +
    geom_boxplot(aes(x = season,
                     y = cnt,
                     fill = season))
```

## Modelling

9. Fit a linear model predicting total daily bike rentals from daily temperature.
Write the linear model, interpret the slope and the intercept in context of the
data, and determine and interpret the $R^2$.

```{r}
lm_bike_share <- lm(cnt ~ raw_temp, bike_share_data)
tidy(lm_bike_share)
glance(lm_bike_share)
```

10. Fit another linear model predicting total daily bike rentals from daily
feeling temperature. Write the linear model, interpret the slope and the intercept
in context of the data, and determine and interpret the $R^2$. Is temperature or
feeling temperature a better predictor of bike rentals? Explain your reasoning.

```{r}
lm2_bike_share <- lm(cnt ~ raw_atemp, bike_share_data)
summary(lm2_bike_share)
```

Both the feeling temperature and the raw temperature explain the same amount of variability in the data. They are comparable.

11. Fit a model predicting total daily bike rentals from season, year, whether
the day is holiday or not, whether the day is a workingday or not, the weather
category, temperature, feeling temperature, humidity, and windspeed, as well as
the interaction between feeling temperature and holiday. Record adjusted $R^2$
of the model.

```{r}
lm3_bike_share <- lm(cnt ~ season + yr + holiday + workingday +
                     weathersit + raw_temp + raw_atemp + raw_hum +
                     raw_windspeed + raw_atemp*holiday,
                     bike_share_data)
```

12. Write the linear models for holidays and non-holidays. Is the slope of
temperature the same or different for these two models? How about the slope
for feeling temperature? Why or why not?

```{r}
lm_temp_hol <- lm(cnt ~ season + raw_temp + raw_atemp,
                  filter(bike_share_data), holiday == "yes")
lm_temp_n_hol <- lm(cnt ~ season + raw_temp + raw_atemp,
                    filter(bike_share_data), holiday == "no")

tidy(lm_temp_hol)
tidy(lm_temp_n_hol)
```

13. Interpret the slopes of season and feeling temperature. If the slopes are
different for holidays and non-holidays, make sure to interpret both. If the
variable has multiple levels, make sure you interpret all of the slope coefficients
associated with it.

14. Interpret the intercept. If the intercept is different for holidays and
non-holidays, make sure to interpret both.

15. According to this model, assuming everything else is the same, in which
season does the model predict total daily bike rentals to be highest and
which to be the lowest?

16. Perform the first step of backward selection by fitting a series of models,
each with one explanatory variable removed from the model you fit in the previous
exercise. Record adjusted $R^2$s of each of these models. Which model of these
models, if any, gives the highest improvement over the model in the previous
exercise?
